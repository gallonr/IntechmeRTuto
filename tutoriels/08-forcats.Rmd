---
title: "Manipulation de facteurs avec forcats"
subtitle: "Ma√Ætriser les variables cat√©gorielles"
output: 
  learnr::tutorial:
    progressive: true
    allow_skip: true
    theme: cosmo
    css: ../css/custom.css
    language:
      fr:
        button:
          runcode: "Ex√©cuter le code"
          hints: "Indice"
          solution: "Solution"
          continue: "Continuer"
          submitanswer: "Soumettre"
          previoustopic: "Th√®me pr√©c√©dent"
          nexttopic: "Th√®me suivant"
        text:
          startover: "Recommencer"
          areyousure: "√ätes-vous s√ªr de vouloir recommencer ? (Toute progression sera perdue)"
runtime: shiny_prerendered
description: "R√©ordonner, recoder et regrouper vos facteurs avec forcats"
---

```{r setup, include=FALSE}
library(learnr)
library(tidyverse)

knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE,
  error = FALSE
)

# Donn√©es d'exemple
enquete <- tibble(
  id = 1:20,
  satisfaction = factor(
    c("Tr√®s satisfait", "Satisfait", "Neutre", "Insatisfait", "Tr√®s satisfait",
      "Satisfait", "Tr√®s satisfait", "Neutre", "Satisfait", "Tr√®s satisfait",
      "Satisfait", "Neutre", "Insatisfait", "Tr√®s satisfait", "Satisfait",
      "Tr√®s satisfait", "Neutre", "Satisfait", "Tr√®s insatisfait", "Satisfait"),
    levels = c("Tr√®s insatisfait", "Insatisfait", "Neutre", "Satisfait", "Tr√®s satisfait")
  ),
  age_groupe = factor(
    c("18-25", "26-35", "36-45", "46-55", "18-25", "26-35", "36-45", "18-25",
      "26-35", "18-25", "26-35", "36-45", "46-55", "56+", "18-25", "26-35",
      "36-45", "18-25", "26-35", "18-25"),
    levels = c("18-25", "26-35", "36-45", "46-55", "56+")
  )
)

ventes <- tibble(
  mois = factor(
    c("Jan", "Fev", "Mar", "Avr", "Mai", "Jui", "Jui", "Aou", "Sep", "Oct", "Nov", "Dec"),
    levels = c("Jan", "Fev", "Mar", "Avr", "Mai", "Jui", "Jui", "Aou", "Sep", "Oct", "Nov", "Dec")
  ),
  montant = c(15000, 18000, 22000, 25000, 28000, 30000, 32000, 31000, 29000, 27000, 24000, 35000)
)

produits_ventes <- tibble(
  produit = c("Ordinateur", "Souris", "Clavier", "√âcran", "USB", 
              "Casque", "Webcam", "Imprimante", "Scanner", "Tablette",
              "Cable HDMI", "Adaptateur", "Souris", "Clavier", "Ordinateur"),
  quantite = c(150, 2000, 800, 300, 1500, 450, 200, 180, 90, 120, 3000, 500, 1800, 750, 140)
) |>
  group_by(produit) |>
  summarise(total = sum(quantite)) |>
  mutate(produit = factor(produit))
```

```{r logo, echo=FALSE, results='asis'}
htmltools::img(src = "images/logo.png",
               id = "tutorial-logo",
               alt = "Logo Cnam-Intechmer")
```

## Bienvenue {data-progressive=TRUE}

### Introduction

Bienvenue dans ce tutoriel sur la **manipulation de facteurs avec forcats** !

Les **facteurs** sont la fa√ßon dont R repr√©sente les variables cat√©gorielles (sexe, cat√©gorie professionnelle, niveau d'√©ducation, etc.). Ils sont essentiels pour les analyses statistiques et les graphiques, mais peuvent √™tre d√©licats √† manipuler. Le package `forcats` (anagramme de "factors") rend ce travail beaucoup plus simple !

**Objectifs d'apprentissage :**

- ‚úÖ Comprendre ce qu'est un **facteur** et pourquoi c'est utile
- ‚úÖ R√©ordonner les niveaux avec `fct_relevel()`, `fct_reorder()`, `fct_infreq()`
- ‚úÖ Recoder les niveaux avec `fct_recode()`
- ‚úÖ Regrouper les niveaux rares avec `fct_lump()`
- ‚úÖ Inverser l'ordre avec `fct_rev()`
- ‚úÖ Combiner et modifier des facteurs

**Pr√©requis :**

- Conna√Ætre dplyr et ggplot2
- Bases de R

**Dur√©e estim√©e :** 45 minutes

---

## Section 1 : Qu'est-ce qu'un facteur ?

### Cr√©er un facteur

Un facteur est un vecteur qui ne peut contenir que des valeurs pr√©d√©finies (les **niveaux**).

```{r demo-factor, exercise=TRUE}
# Cr√©er un facteur simple
couleurs <- factor(c("rouge", "bleu", "rouge", "vert", "bleu"))
couleurs

# Voir les niveaux
levels(couleurs)
```

### Pourquoi utiliser des facteurs ?

**Avantages :**
- ‚úÖ Garantit que les valeurs sont valides
- ‚úÖ Contr√¥le l'ordre d'affichage (graphiques, tableaux)
- ‚úÖ Optimise la m√©moire
- ‚úÖ N√©cessaire pour certaines analyses statistiques

```{r demo-factor-order, exercise=TRUE}
# Sans facteur : ordre alphab√©tique
satisfaction_char <- c("Satisfait", "Insatisfait", "Neutre", "Tr√®s satisfait")
sort(satisfaction_char)

# Avec facteur : ordre logique
satisfaction_fact <- factor(
  satisfaction_char,
  levels = c("Insatisfait", "Neutre", "Satisfait", "Tr√®s satisfait")
)
sort(satisfaction_fact)
```

### Exercice 1 : Cr√©er un facteur

Cr√©ez un facteur pour les jours de la semaine dans le bon ordre :

```{r ex1-factor, exercise=TRUE}
jours_desordre <- c("Mercredi", "Lundi", "Vendredi", "Mardi")

# Cr√©ez un facteur avec l'ordre correct
jours_fact <- factor(
  jours_desordre,
  levels = c(_____)
)

sort(jours_fact)
```

```{r ex1-factor-hint}
# L'ordre des jours : Lundi, Mardi, Mercredi, Jeudi, Vendredi, Samedi, Dimanche
levels = c("Lundi", "Mardi", "Mercredi", "Jeudi", "Vendredi", "Samedi", "Dimanche")
```

```{r ex1-factor-solution}
jours_desordre <- c("Mercredi", "Lundi", "Vendredi", "Mardi")

jours_fact <- factor(
  jours_desordre,
  levels = c("Lundi", "Mardi", "Mercredi", "Jeudi", "Vendredi", "Samedi", "Dimanche")
)

sort(jours_fact)
```

---

## Section 2 : R√©ordonner les niveaux

### fct_relevel() - Ordre manuel

`fct_relevel()` permet de changer l'ordre des niveaux manuellement.

```{r demo-relevel, exercise=TRUE}
enquete |>
  count(satisfaction)

# Mettre "Neutre" en premier
enquete |>
  mutate(satisfaction = fct_relevel(satisfaction, "Neutre")) |>
  count(satisfaction)
```

### fct_infreq() - Ordre par fr√©quence

`fct_infreq()` ordonne par fr√©quence d√©croissante (le plus fr√©quent en premier).

```{r demo-infreq, exercise=TRUE}
enquete |>
  mutate(satisfaction = fct_infreq(satisfaction)) |>
  count(satisfaction)
```

üí° Tr√®s utile pour les graphiques en barres !

### Exercice 2 : R√©ordonner par fr√©quence

R√©ordonnez les tranches d'√¢ge par fr√©quence et affichez le compte :

```{r ex2-infreq, exercise=TRUE}
enquete |>
  mutate(age_groupe = _____) |>
  count(age_groupe)
```

```{r ex2-infreq-solution}
enquete |>
  mutate(age_groupe = fct_infreq(age_groupe)) |>
  count(age_groupe)
```

### fct_reorder() - Ordre par une autre variable

`fct_reorder()` ordonne les niveaux selon les valeurs d'une autre variable.

```{r demo-reorder, exercise=TRUE}
# Ordonner les produits par quantit√© totale
produits_ventes |>
  mutate(produit = fct_reorder(produit, total)) |>
  ggplot(aes(x = total, y = produit)) +
  geom_col() +
  labs(title = "Ventes par produit (ordonn√©)")
```

üí° Indispensable pour des graphiques clairs !

---

## Section 3 : fct_rev() - Inverser l'ordre

```{r demo-rev, exercise=TRUE}
enquete |>
  mutate(satisfaction = fct_rev(satisfaction)) |>
  count(satisfaction)
```

### Combiner reorder et rev

```{r demo-reorder-rev, exercise=TRUE}
# Produits ordonn√©s par total d√©croissant
produits_ventes |>
  mutate(produit = fct_reorder(produit, total) |> fct_rev()) |>
  ggplot(aes(x = total, y = produit)) +
  geom_col()
```

---

## Section 4 : Quiz - R√©ordonnancement

```{r quiz-reorder}
quiz(
  caption = "Testez vos connaissances",
  
  question("Quelle fonction ordonne les niveaux par fr√©quence ?",
    answer("fct_infreq()", correct = TRUE),
    answer("fct_reorder()"),
    answer("fct_relevel()"),
    answer("fct_count()"),
    allow_retry = TRUE
  ),
  
  question("Comment ordonner un facteur selon les valeurs d'une variable num√©rique ?",
    answer("fct_reorder(facteur, variable_numerique)", correct = TRUE),
    answer("fct_infreq(facteur)"),
    answer("fct_relevel(facteur, variable_numerique)"),
    answer("arrange(facteur, variable_numerique)"),
    allow_retry = TRUE
  ),
  
  question("Quelle fonction inverse l'ordre des niveaux ?",
    answer("fct_rev()", correct = TRUE),
    answer("fct_reverse()"),
    answer("fct_invert()"),
    answer("rev()"),
    allow_retry = TRUE
  ),
  
  question("Pourquoi utiliser des facteurs plut√¥t que des cha√Ænes de caract√®res ?",
    answer("Pour contr√¥ler l'ordre d'affichage", correct = TRUE),
    answer("Pour garantir des valeurs valides", correct = TRUE),
    answer("Pour optimiser la m√©moire", correct = TRUE),
    answer("Parce que c'est obligatoire en R"),
    allow_retry = TRUE,
    random_answer_order = TRUE
  )
)
```

---

## Section 5 : Recoder les niveaux

### fct_recode() - Renommer les niveaux

`fct_recode()` permet de renommer des niveaux.

```{r demo-recode, exercise=TRUE}
enquete |>
  mutate(
    satisfaction_fr = fct_recode(satisfaction,
      "Tr√®s insatisfait" = "Tr√®s insatisfait",  # Peut rester identique
      "Pas satisfait" = "Insatisfait",          # Renommer
      "Neutre" = "Neutre",
      "Content" = "Satisfait",
      "Tr√®s content" = "Tr√®s satisfait"
    )
  ) |>
  count(satisfaction_fr)
```

### Exercice 3 : Recoder

Simplifiez les niveaux de satisfaction en seulement 3 cat√©gories :

```{r ex3-recode, exercise=TRUE}
enquete |>
  mutate(
    satisfaction_simple = fct_recode(satisfaction,
      "N√©gatif" = "Tr√®s insatisfait",
      "N√©gatif" = "Insatisfait",
      _____ = _____,
      _____ = _____,
      _____ = _____
    )
  ) |>
  count(satisfaction_simple)
```

```{r ex3-recode-hint}
# Regroupez "Satisfait" et "Tr√®s satisfait" en "Positif"
# Gardez "Neutre"
```

```{r ex3-recode-solution}
enquete |>
  mutate(
    satisfaction_simple = fct_recode(satisfaction,
      "N√©gatif" = "Tr√®s insatisfait",
      "N√©gatif" = "Insatisfait",
      "Neutre" = "Neutre",
      "Positif" = "Satisfait",
      "Positif" = "Tr√®s satisfait"
    )
  ) |>
  count(satisfaction_simple)
```

---

## Section 6 : Regrouper les niveaux rares

### fct_lump() - Regrouper en "Other"

`fct_lump()` regroupe les niveaux les moins fr√©quents dans une cat√©gorie "Other".

```{r demo-lump, exercise=TRUE}
# Garder les 3 produits les plus vendus
produits_ventes |>
  mutate(produit_groupe = fct_lump(produit, n = 3, w = total)) |>
  count(produit_groupe, wt = total, sort = TRUE)
```

### fct_lump_min() - Seuil minimum

```{r demo-lump-min, exercise=TRUE}
# Garder seulement les produits avec > 500 ventes
produits_ventes |>
  mutate(produit_groupe = fct_lump_min(produit, min = 500, w = total)) |>
  count(produit_groupe, wt = total, sort = TRUE)
```

### Exercice 4 : Regrouper

Gardez les 2 tranches d'√¢ge les plus fr√©quentes, regroupez les autres en "Autres" :

```{r ex4-lump, exercise=TRUE}
enquete |>
  mutate(age_simplifie = fct_lump(age_groupe, n = _____)) |>
  count(age_simplifie)
```

```{r ex4-lump-solution}
enquete |>
  mutate(age_simplifie = fct_lump(age_groupe, n = 2)) |>
  count(age_simplifie)
```

### Renommer "Other"

```{r demo-lump-other, exercise=TRUE}
produits_ventes |>
  mutate(
    produit_groupe = fct_lump(produit, n = 3, w = total),
    produit_groupe = fct_recode(produit_groupe, "Autres produits" = "Other")
  ) |>
  count(produit_groupe, wt = total)
```

---

## Section 7 : Autres fonctions utiles

### fct_drop() - Supprimer les niveaux non utilis√©s

```{r demo-drop, exercise=TRUE}
# Apr√®s un filtre, des niveaux peuvent rester vides
satisfaction_filtre <- enquete |>
  filter(satisfaction %in% c("Satisfait", "Tr√®s satisfait")) |>
  pull(satisfaction)

levels(satisfaction_filtre)  # Tous les niveaux sont l√† !

# Supprimer les niveaux non utilis√©s
satisfaction_filtre |> fct_drop() |> levels()
```

### fct_expand() - Ajouter des niveaux

```{r demo-expand, exercise=TRUE}
# Ajouter un niveau qui n'existe pas encore
jours <- factor(c("Lundi", "Mardi", "Lundi"))
jours_etendus <- fct_expand(jours, "Mercredi", "Jeudi", "Vendredi")
levels(jours_etendus)
```

### fct_collapse() - Regrouper sp√©cifiquement

```{r demo-collapse, exercise=TRUE}
enquete |>
  mutate(
    sentiment = fct_collapse(satisfaction,
      N√©gatif = c("Tr√®s insatisfait", "Insatisfait"),
      Neutre = "Neutre",
      Positif = c("Satisfait", "Tr√®s satisfait")
    )
  ) |>
  count(sentiment)
```

---

## Section 8 : D√©fi final

### Analyse compl√®te des donn√©es d'enqu√™te

```{r defi-final, exercise=TRUE, exercise.lines=25}
enquete

# Mission :
# 1. Simplifiez 'satisfaction' en 3 niveaux : N√©gatif, Neutre, Positif
# 2. Regroupez les tranches d'√¢ge : gardez les 2 plus fr√©quentes
# 3. Comptez les combinaisons √¢ge x satisfaction
# 4. Ordonnez le r√©sultat par fr√©quence d√©croissante
# 5. Cr√©ez un graphique en barres






```

```{r defi-final-hint-1}
# √âtape 1 : Recoder satisfaction
enquete |>
  mutate(
    satisfaction = fct_collapse(satisfaction,
      N√©gatif = c("Tr√®s insatisfait", "Insatisfait"),
      Neutre = "Neutre",
      Positif = c("Satisfait", "Tr√®s satisfait")
    )
  )
```

```{r defi-final-hint-2}
# √âtapes 1-4
enquete |>
  mutate(
    satisfaction = fct_collapse(satisfaction,
      N√©gatif = c("Tr√®s insatisfait", "Insatisfait"),
      Neutre = "Neutre",
      Positif = c("Satisfait", "Tr√®s satisfait")
    ),
    age_groupe = fct_lump(age_groupe, n = 2)
  ) |>
  count(age_groupe, satisfaction) |>
  arrange(desc(n))
```

```{r defi-final-solution}
enquete_nettoyee <- enquete |>
  mutate(
    # 1. Simplifier satisfaction
    satisfaction = fct_collapse(satisfaction,
      N√©gatif = c("Tr√®s insatisfait", "Insatisfait"),
      Neutre = "Neutre",
      Positif = c("Satisfait", "Tr√®s satisfait")
    ),
    # 2. Regrouper √¢ges
    age_groupe = fct_lump(age_groupe, n = 2) |>
                 fct_recode("Autres" = "Other")
  )

# 3-4. Compter et trier
resultats <- enquete_nettoyee |>
  count(age_groupe, satisfaction) |>
  arrange(desc(n))

resultats

# 5. Graphique
enquete_nettoyee |>
  ggplot(aes(x = age_groupe, fill = satisfaction)) +
  geom_bar(position = "dodge") +
  labs(
    title = "Satisfaction par tranche d'√¢ge",
    x = "Tranche d'√¢ge",
    y = "Nombre de r√©pondants",
    fill = "Satisfaction"
  ) +
  theme_minimal()
```

---

## R√©capitulatif

### Ce que vous avez appris

- ‚úÖ **Cr√©er et comprendre** les facteurs
- ‚úÖ **R√©ordonner** avec `fct_relevel()`, `fct_reorder()`, `fct_infreq()`, `fct_rev()`
- ‚úÖ **Recoder** avec `fct_recode()` et `fct_collapse()`
- ‚úÖ **Regrouper** avec `fct_lump()` et variantes
- ‚úÖ **Nettoyer** avec `fct_drop()`

### Pour aller plus loin

**Tutoriel suivant :** "09 - Dates et temps avec lubridate"

**Ressources :**

- [R for Data Science - Factors](https://r4ds.hadley.nz/factors.html)
- [Documentation forcats](https://forcats.tidyverse.org/)
- [Cheatsheet forcats](https://github.com/rstudio/cheatsheets/blob/main/factors.pdf)

### Aide-m√©moire

```{r cheatsheet, echo=TRUE, eval=FALSE}
# CR√âER UN FACTEUR
factor(vecteur, levels = c("ordre", "souhait√©"))

# R√âORDONNER
fct_relevel(f, "niveau1", "niveau2")  # Manuel
fct_infreq(f)                         # Par fr√©quence
fct_reorder(f, x)                     # Par autre variable
fct_rev(f)                            # Inverser

# RECODER
fct_recode(f,
  "nouveau1" = "ancien1",
  "nouveau2" = "ancien2"
)

fct_collapse(f,
  "groupe1" = c("a", "b"),
  "groupe2" = c("c", "d")
)

# REGROUPER
fct_lump(f, n = 5)           # Garder top 5
fct_lump_min(f, min = 100)   # Seuil minimum
fct_lump_prop(f, prop = 0.1) # Seuil proportionnel

# NETTOYER
fct_drop(f)                  # Supprimer niveaux non utilis√©s
fct_expand(f, "nouveau")     # Ajouter niveau

# COMBINER
fct_c(f1, f2)               # Combiner facteurs
fct_unify(list(f1, f2))     # Unifier niveaux
```

---

<div class="footer">
  <p>@ Cnam-Intechmer - 2025</p>
</div>
