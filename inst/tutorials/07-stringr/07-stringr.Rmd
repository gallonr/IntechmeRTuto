---
title: "Manipulation de texte avec stringr"
subtitle: "Ma√Ætriser les cha√Ænes de caract√®res"
output: 
  learnr::tutorial:
    progressive: true
    allow_skip: true
    theme: cosmo
    css: ../css/custom.css
    language:
      fr:
        button:
          runcode: "Ex√©cuter le code"
          hints: "Indice"
          solution: "Solution"
          continue: "Continuer"
          submitanswer: "Soumettre"
          previoustopic: "Th√®me pr√©c√©dent"
          nexttopic: "Th√®me suivant"
        text:
          startover: "Recommencer"
          areyousure: "√ätes-vous s√ªr de vouloir recommencer ? (Toute progression sera perdue)"
runtime: shiny_prerendered
description: "D√©tecter, extraire, remplacer et transformer du texte avec stringr"
---

```{r setup, include=FALSE}
library(learnr)
library(tidyverse)

knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE,
  error = FALSE
)

# Donn√©es d'exemple
produits <- tibble(
  id = 1:6,
  nom = c("Ordinateur Portable HP", "Souris Logitech", "Clavier M√©canique",
          "√âcran 24 pouces", "USB 3.0 64GB", "Casque Bluetooth"),
  prix_txt = c("899.99‚Ç¨", "12.50‚Ç¨", "145.00‚Ç¨", "299.99‚Ç¨", "25.50‚Ç¨", "89.90‚Ç¨"),
  reference = c("ORD-2024-001", "SOU-2024-045", "CLA-2024-032",
                "ECR-2024-012", "USB-2024-099", "CAS-2024-055")
)

clients <- tibble(
  nom = c("  Dupont  ", "MARTIN", "bernard", "  Dubois  "),
  email = c("marie.dupont@email.com", "pierre.martin@EMAIL.FR",
            "sophie.bernard@Email.Com", "luc.dubois@email.fr"),
  telephone = c("+33 6 12 34 56 78", "06.98.76.54.32",
                "+33-7-11-22-33-44", "0611223344")
)
```

```{r logo, echo=FALSE, results='asis'}
htmltools::img(src = "images/logo.png",
               id = "tutorial-logo",
               alt = "Logo Cnam-Intechmer")
```

## Bienvenue {data-progressive=TRUE}

### Introduction

Bienvenue dans ce tutoriel sur la **manipulation de texte avec stringr** !

Les donn√©es textuelles sont partout : noms, adresses, descriptions de produits, commentaires... Mais elles sont souvent d√©sordonn√©es, avec des espaces en trop, des majuscules/minuscules incoh√©rentes, ou des formats vari√©s. Le package `stringr` vous donne les outils pour nettoyer et transformer efficacement vos cha√Ænes de caract√®res.

**Objectifs d'apprentissage :**

- ‚úÖ D√©tecter des motifs avec `str_detect()` et `str_count()`
- ‚úÖ Extraire du texte avec `str_extract()` et `str_sub()`
- ‚úÖ Remplacer du texte avec `str_replace()` et `str_remove()`
- ‚úÖ Transformer la casse avec `str_to_lower()`, `str_to_upper()`, `str_to_title()`
- ‚úÖ Nettoyer les espaces avec `str_trim()` et `str_squish()`
- ‚úÖ D√©couper et combiner avec `str_split()` et `str_c()`

**Pr√©requis :**

- Conna√Ætre dplyr (tutoriels 03-05)
- Comprendre les tibbles

**Dur√©e estim√©e :** 45 minutes

---

## Section 1 : D√©tecter des motifs

### La fonction str_detect()

`str_detect()` teste si un motif est pr√©sent dans une cha√Æne. Retourne `TRUE` ou `FALSE`.

```{r demo-detect, exercise=TRUE}
# V√©rifier si "Ordinateur" est dans le nom
produits |>
  mutate(est_ordinateur = str_detect(nom, "Ordinateur"))
```

### Utiliser avec filter()

```{r demo-detect-filter, exercise=TRUE}
# Filtrer les produits contenant "USB" ou "Casque"
produits |>
  filter(str_detect(nom, "USB|Casque"))
```

üí° Le symbole `|` signifie "OU" en expressions r√©guli√®res.

### Exercice 1 : D√©tecter un motif

Filtrez les produits dont le nom contient "Logitech" :

```{r ex1-detect, exercise=TRUE}
produits |>
  filter(_____)
```

```{r ex1-detect-hint}
# Utilisez str_detect(nom, "motif")
filter(str_detect(nom, "Logitech"))
```

```{r ex1-detect-solution}
produits |>
  filter(str_detect(nom, "Logitech"))
```

### La fonction str_count()

`str_count()` compte le nombre d'occurrences d'un motif.

```{r demo-count, exercise=TRUE}
# Compter le nombre de voyelles
texte <- c("Bonjour", "Hello", "Salut")
tibble(texte) |>
  mutate(nb_voyelles = str_count(texte, "[aeiouAEIOU]"))
```

üí° `[aeiou]` est une **classe de caract√®res** : correspond √† n'importe quelle voyelle.

---

## Section 2 : Extraire du texte

### La fonction str_extract()

`str_extract()` extrait la premi√®re occurrence d'un motif.

```{r demo-extract, exercise=TRUE}
# Extraire les nombres des prix
produits |>
  mutate(prix_nombre = str_extract(prix_txt, "[0-9.]+"))
```

üí° `[0-9.]+` signifie : un ou plusieurs (`+`) chiffres ou points.

### str_extract_all()

```{r demo-extract-all, exercise=TRUE}
# Extraire tous les nombres d'une cha√Æne
texte <- "J'ai 2 chats, 3 chiens et 15 poissons"
str_extract_all(texte, "[0-9]+")
```

### Exercice 2 : Extraire des nombres

Extrayez le code num√©rique de la r√©f√©rence (les 3 derniers chiffres) :

```{r ex2-extract, exercise=TRUE}
produits |>
  select(reference) |>
  mutate(code = str_extract(reference, _____))
```

```{r ex2-extract-hint}
# Le pattern pour 3 chiffres √† la fin : "[0-9]{3}$"
# {3} = exactement 3
# $ = fin de cha√Æne
mutate(code = str_extract(reference, "[0-9]{3}$"))
```

```{r ex2-extract-solution}
produits |>
  select(reference) |>
  mutate(code = str_extract(reference, "[0-9]{3}$"))
```

### La fonction str_sub()

`str_sub()` extrait par position (d√©but et fin).

```{r demo-sub, exercise=TRUE}
# Extraire les 3 premiers caract√®res
produits |>
  mutate(categorie = str_sub(reference, 1, 3))
```

---

## Section 3 : Remplacer et supprimer

### La fonction str_replace()

`str_replace()` remplace la **premi√®re** occurrence d'un motif.

```{r demo-replace, exercise=TRUE}
# Remplacer "‚Ç¨" par " euros"
produits |>
  mutate(prix_txt = str_replace(prix_txt, "‚Ç¨", " euros"))
```

### str_replace_all()

`str_replace_all()` remplace **toutes** les occurrences.

```{r demo-replace-all, exercise=TRUE}
# Uniformiser les t√©l√©phones : retirer tous les s√©parateurs
clients |>
  mutate(tel_propre = str_replace_all(telephone, "[ .+-]", ""))
```

üí° `[ .+-]` = classe de caract√®res : espace, point, plus ou tiret.

### Exercice 3 : Remplacer du texte

Remplacez tous les points par des tirets dans les t√©l√©phones :

```{r ex3-replace, exercise=TRUE}
clients |>
  select(telephone) |>
  mutate(tel_tirets = str_replace_all(telephone, _____, _____))
```

```{r ex3-replace-hint}
# str_replace_all(colonne, "pattern", "remplacement")
mutate(tel_tirets = str_replace_all(telephone, "\\.", "-"))
# Note : le point doit √™tre √©chapp√© avec \\ car c'est un caract√®re sp√©cial
```

```{r ex3-replace-solution}
clients |>
  select(telephone) |>
  mutate(tel_tirets = str_replace_all(telephone, "\\.", "-"))
```

### La fonction str_remove()

`str_remove()` supprime un motif (√©quivalent √† remplacer par "").

```{r demo-remove, exercise=TRUE}
# Retirer "‚Ç¨" des prix
produits |>
  mutate(prix_nombre = str_remove(prix_txt, "‚Ç¨"))
```

### str_remove_all()

```{r demo-remove-all, exercise=TRUE}
# Retirer tous les espaces
produits |>
  mutate(nom_sans_espaces = str_remove_all(nom, " "))
```

---

## Section 4 : Quiz - D√©tection et remplacement

```{r quiz-string-1}
quiz(
  caption = "Testez vos connaissances",
  
  question("Quelle fonction teste si un motif est pr√©sent dans une cha√Æne ?",
    answer("str_detect()", correct = TRUE),
    answer("str_find()"),
    answer("str_test()"),
    answer("str_match()"),
    allow_retry = TRUE
  ),
  
  question("Quelle est la diff√©rence entre str_replace() et str_replace_all() ?",
    answer("str_replace() remplace seulement la premi√®re occurrence", correct = TRUE),
    answer("str_replace() est plus rapide"),
    answer("str_replace() ne fonctionne qu'avec des regex"),
    answer("Aucune diff√©rence"),
    allow_retry = TRUE
  ),
  
  question("Comment extraire tous les nombres d'une cha√Æne ?",
    answer('str_extract_all(texte, "[0-9]+")', correct = TRUE),
    answer('str_extract(texte, "[0-9]+")'),
    answer('str_detect(texte, "[0-9]+")'),
    answer('str_count(texte, "[0-9]+")'),
    allow_retry = TRUE
  ),
  
  question("Que signifie le pattern '[aeiou]' ?",
    answer("N'importe quelle voyelle minuscule", correct = TRUE),
    answer("Les lettres 'a', 'e', 'i', 'o', 'u' dans cet ordre"),
    answer("Toutes les lettres sauf a, e, i, o, u"),
    answer("Le mot 'aeiou'"),
    allow_retry = TRUE
  )
)
```

---

## Section 5 : Transformer la casse

### Les fonctions de casse

```{r demo-case, exercise=TRUE}
clients |>
  mutate(
    nom_minuscule = str_to_lower(nom),
    nom_majuscule = str_to_upper(nom),
    nom_titre = str_to_title(nom)
  )
```

- `str_to_lower()` : tout en minuscules
- `str_to_upper()` : tout en MAJUSCULES
- `str_to_title()` : Premi√®re Lettre En Majuscule

### Exercice 4 : Uniformiser la casse

Mettez tous les emails en minuscules :

```{r ex4-case, exercise=TRUE}
clients |>
  mutate(email_propre = _____)
```

```{r ex4-case-solution}
clients |>
  mutate(email_propre = str_to_lower(email))
```

---

## Section 6 : Nettoyer les espaces

### La fonction str_trim()

`str_trim()` supprime les espaces au **d√©but et √† la fin**.

```{r demo-trim, exercise=TRUE}
clients |>
  mutate(nom_propre = str_trim(nom))
```

### La fonction str_squish()

`str_squish()` fait encore mieux :
- Supprime les espaces au d√©but et √† la fin
- R√©duit les espaces multiples √† un seul

```{r demo-squish, exercise=TRUE}
texte <- "  Beaucoup    d'espaces   ici  "
str_squish(texte)
```

### Exercice 5 : Nettoyer les noms

Nettoyez les noms des clients : retirez les espaces et mettez en format titre :

```{r ex5-clean, exercise=TRUE}
clients |>
  mutate(nom_propre = _____ |> _____)
```

```{r ex5-clean-hint}
# Combinez str_squish() et str_to_title()
# Utilisez le pipe pour encha√Æner
mutate(nom_propre = nom |> str_squish() |> str_to_title())
```

```{r ex5-clean-solution}
clients |>
  mutate(nom_propre = nom |> str_squish() |> str_to_title())
```

---

## Section 7 : Longueur et d√©coupage

### La fonction str_length()

```{r demo-length, exercise=TRUE}
produits |>
  mutate(longueur_nom = str_length(nom))
```

### La fonction str_split()

`str_split()` d√©coupe une cha√Æne selon un s√©parateur.

```{r demo-split, exercise=TRUE}
# D√©couper une r√©f√©rence
str_split("ORD-2024-001", "-")

# R√©sultat : une liste !
# Pour obtenir les parties dans des colonnes, 
# utilisez separate_wider_delim() de tidyr
```

### La fonction str_c()

`str_c()` combine (concat√®ne) des cha√Ænes.

```{r demo-concat, exercise=TRUE}
# Combiner plusieurs colonnes
produits |>
  mutate(description = str_c(nom, " - Ref: ", reference))
```

Avec `sep` pour ajouter un s√©parateur :

```{r demo-concat-sep, exercise=TRUE}
str_c("Bonjour", "le", "monde", sep = " ")
```

---

## Section 8 : Expressions r√©guli√®res courantes

### Patterns utiles

| Pattern | Signification | Exemple |
|---------|---------------|---------|
| `^texte` | D√©but de cha√Æne | `^ORD` trouve "ORD-2024" |
| `texte$` | Fin de cha√Æne | `001$` trouve "ORD-2024-001" |
| `[abc]` | Un de ces caract√®res | `[aeiou]` trouve voyelles |
| `[^abc]` | Tout sauf ces caract√®res | `[^0-9]` trouve non-chiffres |
| `.` | N'importe quel caract√®re | `a.b` trouve "aXb" |
| `*` | 0 ou plus | `a*` trouve "", "a", "aa"... |
| `+` | 1 ou plus | `a+` trouve "a", "aa", "aaa"... |
| `{n}` | Exactement n | `a{3}` trouve "aaa" |
| `{n,m}` | Entre n et m | `a{2,4}` trouve "aa", "aaa", "aaaa" |
| `|` | OU | `chat|chien` trouve l'un ou l'autre |

### Exemples pratiques

```{r demo-regex, exercise=TRUE}
emails <- c("test@email.com", "invalide", "autre@test.fr", "pas_email")

tibble(email = emails) |>
  mutate(
    # Emails valides (simplifi√©)
    valide = str_detect(email, "@.+\\..+"),
    # Domaine .com
    est_com = str_detect(email, "\\.com$"),
    # Extraire le domaine
    domaine = str_extract(email, "@(.+)") |> str_remove("@")
  )
```

---

## Section 9 : D√©fi final

### Mission : Nettoyage complet de donn√©es clients

Nettoyez la base de donn√©es clients :

```{r defi-final, exercise=TRUE, exercise.lines=20}
clients

# Mission :
# 1. Nettoyez les noms : trim + format titre
# 2. Uniformisez les emails : tout en minuscules
# 3. V√©rifiez que les emails contiennent @
# 4. Uniformisez les t√©l√©phones : format sans s√©parateurs (10 chiffres)
# 5. Gardez seulement les clients avec email valide
# 6. Affichez : nom_propre, email_propre, tel_propre









```

```{r defi-final-hint-1}
# Commencez par nettoyer les noms
clients |>
  mutate(
    nom_propre = nom |> str_trim() |> str_to_title(),
    email_propre = str_to_lower(email)
  )
```

```{r defi-final-hint-2}
# Ajoutez la v√©rification email et nettoyage t√©l√©phone
clients |>
  mutate(
    nom_propre = nom |> str_trim() |> str_to_title(),
    email_propre = str_to_lower(email),
    email_valide = str_detect(email_propre, "@"),
    tel_propre = str_replace_all(telephone, "[ .+-]", "")
  )
```

```{r defi-final-solution}
clients |>
  mutate(
    # 1. Nettoyage noms
    nom_propre = nom |> str_trim() |> str_to_title(),
    # 2. Uniformisation emails
    email_propre = str_to_lower(email),
    # 3. V√©rification emails
    email_valide = str_detect(email_propre, "@.+\\..+"),
    # 4. Uniformisation t√©l√©phones
    tel_propre = str_replace_all(telephone, "[ .+-]", "")
  ) |>
  # 5. Filtrer emails valides
  filter(email_valide) |>
  # 6. S√©lection finale
  select(nom_propre, email_propre, tel_propre)
```

---

## R√©capitulatif

### Ce que vous avez appris

- ‚úÖ **D√©tecter** des motifs avec `str_detect()` et `str_count()`
- ‚úÖ **Extraire** du texte avec `str_extract()`, `str_sub()`
- ‚úÖ **Remplacer** avec `str_replace()`, `str_remove()`
- ‚úÖ **Transformer la casse** avec `str_to_lower()`, `str_to_upper()`, `str_to_title()`
- ‚úÖ **Nettoyer** avec `str_trim()`, `str_squish()`
- ‚úÖ **Combiner** avec `str_c()`
- ‚úÖ Utiliser des **expressions r√©guli√®res** de base

### Pour aller plus loin

**Tutoriel suivant :** "08 - Manipulation de facteurs avec forcats"

**Ressources :**

- [R for Data Science - Strings](https://r4ds.hadley.nz/strings.html)
- [R for Data Science - Regular Expressions](https://r4ds.hadley.nz/regexps.html)
- [Documentation stringr](https://stringr.tidyverse.org/)
- [Regex interactif](https://regex101.com/)

### Aide-m√©moire

```{r cheatsheet, echo=TRUE, eval=FALSE}
# D√âTECTER
str_detect(texte, "motif")     # TRUE/FALSE
str_count(texte, "motif")      # Nombre d'occurrences

# EXTRAIRE
str_extract(texte, "motif")     # Premi√®re occurrence
str_extract_all(texte, "motif") # Toutes les occurrences
str_sub(texte, debut, fin)      # Par position

# REMPLACER / SUPPRIMER
str_replace(texte, "motif", "nouveau")     # Premi√®re
str_replace_all(texte, "motif", "nouveau") # Toutes
str_remove(texte, "motif")                 # Supprimer premi√®re
str_remove_all(texte, "motif")             # Supprimer toutes

# CASSE
str_to_lower(texte)    # minuscules
str_to_upper(texte)    # MAJUSCULES
str_to_title(texte)    # Format Titre

# ESPACES
str_trim(texte)        # Retirer d√©but/fin
str_squish(texte)      # Retirer d√©but/fin + r√©duire multiples

# AUTRES
str_length(texte)              # Longueur
str_c(a, b, sep = " ")        # Concat√©ner
str_split(texte, "sep")       # D√©couper

# REGEX COURANTS
"^debut"        # Commence par
"fin$"          # Finit par
"[abc]"         # a ou b ou c
"[0-9]"         # Un chiffre
"[0-9]+"        # Un ou plusieurs chiffres
"."             # N'importe quel caract√®re
"a|b"           # a OU b
```

---

<div class="footer">
  <p>@ Cnam-Intechmer - 2025</p>
</div>
