---
title: "Transformation de données avec dplyr - Partie 1"
subtitle: "Sélectionner, filtrer et trier vos données"
output: 
  learnr::tutorial:
    progressive: true
    allow_skip: true
    theme: cosmo
    css: ../css/custom.css
    language:
      fr:
        button:
          runcode: "Exécuter le code"
          hints: "Indice"
          solution: "Solution"
          continue: "Continuer"
          submitanswer: "Soumettre"
          previoustopic: "Thème précédent"
          nexttopic: "Thème suivant"
        text:
          startover: "Recommencer"
          areyousure: "Êtes-vous sûr de vouloir recommencer ? (Toute progression sera perdue)"
runtime: shiny_prerendered
description: "Maîtriser select(), filter() et arrange() pour transformer vos données"
---

```{r setup, include=FALSE}
library(learnr)
library(tidyverse)

knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE,
  error = FALSE
)

# Données d'exemple : étudiants
etudiants <- tibble(
  id = 1:10,
  nom = c("Dupont", "Martin", "Bernard", "Dubois", "Moreau",
          "Laurent", "Simon", "Michel", "Leroy", "Garcia"),
  prenom = c("Marie", "Pierre", "Sophie", "Luc", "Julie",
             "Thomas", "Emma", "Lucas", "Chloé", "Hugo"),
  age = c(20, 21, 19, 22, 20, 21, 19, 20, 22, 21),
  note_maths = c(15.5, 12.0, 16.8, 10.5, 14.0, 13.5, 17.5, 11.0, 16.0, 14.5),
  note_physique = c(14.2, 13.5, 17.5, 11.0, 15.2, 12.8, 16.5, 10.5, 15.5, 13.0),
  mention = c("Bien", "Assez bien", "Très bien", "Passable", "Bien",
              "Assez bien", "Très bien", "Passable", "Très bien", "Bien")
)

# Données de ventes
ventes <- tibble(
  date = as.Date(c("2024-01-15", "2024-01-16", "2024-01-17", "2024-01-18", "2024-01-19")),
  produit = c("Ordinateur", "Souris", "Clavier", "Écran", "Souris"),
  categorie = c("Informatique", "Accessoire", "Accessoire", "Informatique", "Accessoire"),
  quantite = c(2, 15, 8, 3, 12),
  prix_unitaire = c(899.99, 12.50, 45.00, 299.99, 12.50)
)
```

```{r logo, echo=FALSE, results='asis'}
htmltools::img(src = "images/logo.png",
               id = "tutorial-logo",
               alt = "Cnam-Intechmer")
```

## Bienvenue {data-progressive=TRUE}

### Introduction

Bienvenue dans ce tutoriel sur la **transformation de données avec dplyr** ! 

Le package `dplyr` est le couteau suisse de la manipulation de données en R. Il fournit des verbes simples et cohérents pour réaliser les opérations les plus courantes.

**Objectifs d'apprentissage :**

- ✅ Sélectionner des colonnes avec `select()`
- ✅ Filtrer des lignes avec `filter()`
- ✅ Trier des données avec `arrange()`
- ✅ Utiliser le pipe `|>` pour enchaîner les opérations
- ✅ Combiner plusieurs transformations

**Prérequis :**

- Connaître les tibbles (tutoriel 01)
- Savoir importer des données (tutoriel 02)

**Durée estimée :** 60 minutes

---

## Section 1 : Sélectionner des colonnes

### La fonction `select()`

`select()` permet de **choisir les colonnes** que vous voulez garder (ou exclure).

**Syntaxe de base :**
```r
donnees |> select(colonne1, colonne2, ...)
```

```{r demo-select, exercise=TRUE}
# Sélectionner seulement le nom et l'âge
etudiants |>
  select(nom, prenom, age)
```

### Sélectionner par position

Vous pouvez aussi utiliser des positions :

```{r demo-select-position, exercise=TRUE}
# Sélectionner les 3 premières colonnes
etudiants |>
  select(1:3)
```

### Exercice 1 : Sélection simple

Sélectionnez uniquement les colonnes `nom`, `note_maths` et `note_physique` :

```{r ex1-select, exercise=TRUE}
etudiants |>
  select(_____)
```

```{r ex1-select-hint}
# Listez les noms des colonnes séparés par des virgules
select(nom, note_maths, note_physique)
```

```{r ex1-select-solution}
etudiants |>
  select(nom, note_maths, note_physique)
```

### Exclure des colonnes

Utilisez `-` pour exclure des colonnes :

```{r demo-select-exclude, exercise=TRUE}
# Tout sauf l'id
etudiants |>
  select(-id)
```

### Exercice 2 : Exclusion

Sélectionnez toutes les colonnes SAUF `id` et `mention` :

```{r ex2-select-exclude, exercise=TRUE}
etudiants |>
  select(_____)
```

```{r ex2-select-exclude-hint}
# Utilisez - devant chaque colonne à exclure
select(-id, -mention)
```

```{r ex2-select-exclude-solution}
etudiants |>
  select(-id, -mention)
```

---

## Section 2 : Fonctions auxiliaires de select()

### Sélection par motif

dplyr propose des fonctions pratiques pour sélectionner par motif :

| Fonction | Utilité |
|----------|---------|
| `starts_with("xxx")` | Colonnes commençant par "xxx" |
| `ends_with("xxx")` | Colonnes finissant par "xxx" |
| `contains("xxx")` | Colonnes contenant "xxx" |
| `matches("regex")` | Colonnes matchant une regex |
| `where(is.numeric)` | Colonnes d'un certain type |

```{r demo-helpers, exercise=TRUE}
# Toutes les colonnes de notes
etudiants |>
  select(starts_with("note"))
```

### Exercice 3 : Sélection par motif

Sélectionnez toutes les colonnes qui commencent par "note" dans le tableau des étudiants :

```{r ex3-helpers, exercise=TRUE}
etudiants |>
  select(_____)
```

```{r ex3-helpers-hint}
# Utilisez starts_with()
```

```{r ex3-helpers-solution}
etudiants |>
  select(starts_with("note"))
```

### Sélectionner par type

```{r demo-where, exercise=TRUE}
# Toutes les colonnes numériques
etudiants |>
  select(where(is.numeric))
```

---

## Section 3 : Filtrer des lignes

### La fonction `filter()`

`filter()` permet de **sélectionner les lignes** qui respectent une condition.

```{r demo-filter, exercise=TRUE}
# Étudiants de plus de 20 ans
etudiants |>
  filter(age > 20)
```

### Opérateurs de comparaison

| Opérateur | Signification |
|-----------|---------------|
| `==` | Égal à |
| `!=` | Différent de |
| `>` | Supérieur à |
| `>=` | Supérieur ou égal |
| `<` | Inférieur à |
| `<=` | Inférieur ou égal |

```{r demo-filter-operators, exercise=TRUE}
# Notes de maths supérieures ou égales à 15
etudiants |>
  filter(note_maths >= 15)
```

### Exercice 4 : Filtrage simple

Filtrez les étudiants qui ont eu plus de 16 en physique :

```{r ex4-filter, exercise=TRUE}
etudiants |>
  filter(_____)
```

```{r ex4-filter-hint}
# filter(note_physique > 16)
```

```{r ex4-filter-solution}
etudiants |>
  filter(note_physique > 16)
```

### Combiner plusieurs conditions

Utilisez `&` (ET) et `|` (OU) :

```{r demo-filter-multiple, exercise=TRUE}
# Étudiants de 20 ans ET note de maths > 14
etudiants |>
  filter(age == 20 & note_maths > 14)

# Étudiants avec mention Bien OU Très bien
etudiants |>
  filter(mention == "Bien" | mention == "Très bien")
```

### Exercice 5 : Conditions multiples

Filtrez les étudiants qui ont :
- Plus de 15 en maths ET
- Plus de 15 en physique

```{r ex5-filter-multiple, exercise=TRUE}
etudiants |>
  filter(_____)
```

```{r ex5-filter-multiple-hint}
# Combinez deux conditions avec &
filter(note_maths > 15 & note_physique > 15)
```

```{r ex5-filter-multiple-solution}
etudiants |>
  filter(note_maths > 15 & note_physique > 15)
```

### L'opérateur %in%

Pour tester l'appartenance à un ensemble :

```{r demo-in, exercise=TRUE}
# Étudiants avec mention Bien ou Très bien
etudiants |>
  filter(mention %in% c("Bien", "Très bien"))
```

---

## Section 4 : Quiz - select et filter

```{r quiz-select-filter}
quiz(
  caption = "Testez vos connaissances",
  
  question("Quelle fonction utilise-t-on pour sélectionner des colonnes ?",
    answer("select()", correct = TRUE),
    answer("filter()"),
    answer("choose()"),
    answer("pick()"),
    allow_retry = TRUE
  ),
  
  question("Comment exclure la colonne 'id' d'un tibble ?",
    answer("select(-id)", correct = TRUE),
    answer("select(!id)"),
    answer("filter(-id)"),
    answer("remove(id)"),
    allow_retry = TRUE
  ),
  
  question("Quelle fonction sélectionne toutes les colonnes commençant par 'note' ?",
    answer("starts_with('note')", correct = TRUE),
    answer("begins_with('note')"),
    answer("prefix('note')"),
    answer("match('^note')"),
    allow_retry = TRUE
  ),
  
  question("Comment filtrer les lignes où age est supérieur à 20 ?",
    answer("filter(age > 20)", correct = TRUE),
    answer("select(age > 20)"),
    answer("filter(age >= 20)"),
    answer("where(age > 20)"),
    allow_retry = TRUE,
    incorrect = "Attention : filter(age >= 20) inclurait aussi 20"
  ),
  
  question("Quel opérateur signifie 'ET' dans une condition de filtrage ?",
    answer("&", correct = TRUE),
    answer("|"),
    answer("&&"),
    answer("AND"),
    allow_retry = TRUE
  )
)
```

---

## Section 5 : Trier des données

### La fonction `arrange()`

`arrange()` permet de **trier les lignes** selon une ou plusieurs colonnes.

```{r demo-arrange, exercise=TRUE}
# Trier par âge croissant
etudiants |>
  arrange(age)
```

### Ordre décroissant

Utilisez `desc()` pour l'ordre décroissant :

```{r demo-arrange-desc, exercise=TRUE}
# Trier par note de maths décroissante
etudiants |>
  arrange(desc(note_maths))
```

### Exercice 6 : Tri simple

Triez les étudiants par note de physique décroissante :

```{r ex6-arrange, exercise=TRUE}
etudiants |>
  arrange(_____)
```

```{r ex6-arrange-hint}
# Utilisez desc() pour l'ordre décroissant
```

```{r ex6-arrange-solution}
etudiants |>
  arrange(desc(note_physique))
```

### Tri sur plusieurs colonnes

```{r demo-arrange-multiple, exercise=TRUE}
# Trier par âge puis par nom
etudiants |>
  arrange(age, nom)
```

---

## Section 6 : Combiner les opérations

### Le pipe `|>`

Le pipe permet d'enchaîner les opérations de manière lisible :

```{r demo-pipe, exercise=TRUE}
# Sans pipe (difficile à lire)
arrange(filter(select(etudiants, nom, age, note_maths), note_maths >= 14), desc(note_maths))

# Avec pipe (clair et lisible)
etudiants |>
  select(nom, age, note_maths) |>
  filter(note_maths >= 14) |>
  arrange(desc(note_maths))
```

### Exercice 7 : Pipeline complet

Créez un pipeline qui :
1. Sélectionne nom, prenom, note_maths
2. Filtre les étudiants avec note_maths > 13
3. Trie par note décroissante

```{r ex7-pipeline, exercise=TRUE}
etudiants |>
  _____ |>
  _____ |>
  _____
```

```{r ex7-pipeline-hint-1}
# Commencez par select()
etudiants |>
  select(nom, prenom, note_maths) |>
  _____ |>
  _____
```

```{r ex7-pipeline-hint-2}
# Ensuite filter(), puis arrange()
etudiants |>
  select(nom, prenom, note_maths) |>
  filter(note_maths > 13) |>
  arrange(desc(note_maths))
```

```{r ex7-pipeline-solution}
etudiants |>
  select(nom, prenom, note_maths) |>
  filter(note_maths > 13) |>
  arrange(desc(note_maths))
```

---

## Section 7 : Défi final

### Mission : Analyse des ventes

Utilisez le jeu de données `ventes` pour répondre aux questions suivantes :

```{r defi-final, exercise=TRUE, exercise.lines=20}
# Affichez d'abord les données pour les comprendre
ventes

# Mission :
# 1. Sélectionnez : produit, quantite, prix_unitaire
# 2. Filtrez : quantite >= 5
# 3. Triez : par prix_unitaire décroissant
# 4. Affichez le résultat






```

```{r defi-final-hint-1}
# Utilisez le pipe |> pour enchaîner
ventes |>
  select(___) |>
  filter(___) |>
  arrange(___)
```

```{r defi-final-hint-2}
ventes |>
  select(produit, quantite, prix_unitaire) |>
  filter(quantite >= 5) |>
  arrange(desc(prix_unitaire))
```

```{r defi-final-solution}
ventes |>
  select(produit, quantite, prix_unitaire) |>
  filter(quantite >= 5) |>
  arrange(desc(prix_unitaire))
```

### Défi avancé

Maintenant, trouvez les produits de la catégorie "Accessoire" avec une quantité supérieure à 10 :

```{r defi-avance, exercise=TRUE}
ventes |>
  # Votre code ici


```

```{r defi-avance-solution}
ventes |>
  filter(categorie == "Accessoire" & quantite > 10) |>
  select(produit, quantite, prix_unitaire)
```

---

## Récapitulatif

### Ce que vous avez appris

- ✅ **Sélectionner des colonnes** avec `select()` et ses fonctions auxiliaires
- ✅ **Filtrer des lignes** avec `filter()` et les opérateurs de comparaison
- ✅ **Trier des données** avec `arrange()` et `desc()`
- ✅ **Enchaîner des opérations** avec le pipe `|>`
- ✅ **Combiner plusieurs transformations** en pipelines lisibles

### Les 3 verbes fondamentaux

```{r echo=TRUE, eval=FALSE}
# SELECT : choisir les colonnes
donnees |> select(col1, col2)

# FILTER : choisir les lignes
donnees |> filter(condition)

# ARRANGE : trier
donnees |> arrange(colonne)
donnees |> arrange(desc(colonne))
```

### Pour aller plus loin

**Tutoriel suivant :** "04 - Transformation avec dplyr (partie 2)" - `mutate()` et `rename()`

**Ressources :**

- [R for Data Science - Transform](https://r4ds.hadley.nz/data-transform.html)
- [Documentation dplyr](https://dplyr.tidyverse.org/)
- [Cheatsheet dplyr](https://github.com/rstudio/cheatsheets/blob/main/data-transformation.pdf)

### Aide-mémoire

```{r cheatsheet, echo=TRUE, eval=FALSE}
# SÉLECTION DE COLONNES
select(col1, col2, col3)          # Par nom
select(1:3)                       # Par position
select(-col)                      # Exclure
select(starts_with("prefix"))     # Par préfixe
select(ends_with("suffix"))       # Par suffixe
select(contains("pattern"))       # Contient
select(where(is.numeric))         # Par type

# FILTRAGE DE LIGNES
filter(x > 10)                    # Condition simple
filter(x > 10 & y < 5)           # ET
filter(x > 10 | y < 5)           # OU
filter(x %in% c(1, 2, 3))        # Appartenance
filter(!is.na(x))                # Non manquant

# TRI
arrange(col)                      # Croissant
arrange(desc(col))                # Décroissant
arrange(col1, col2)               # Multi-colonnes

# PIPELINE
donnees |>
  select(cols) |>
  filter(condition) |>
  arrange(desc(col))
```

---

<div class="footer">
  <p>@ Cnam-Intechmer - 2025</p>
</div>
