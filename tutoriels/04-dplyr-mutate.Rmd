---
title: "Transformation de données avec dplyr - Partie 2"
subtitle: "Créer et modifier des colonnes"
output: 
  learnr::tutorial:
    progressive: true
    allow_skip: true
    theme: cosmo
    css: ../css/custom.css
    language:
      fr:
        button:
          runcode: "Exécuter le code"
          hints: "Indice"
          solution: "Solution"
runtime: shiny_prerendered
description: "Maîtriser mutate() et rename() pour transformer vos colonnes"
---

```{r setup, include=FALSE}
library(learnr)
library(tidyverse)

knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, error = FALSE)

etudiants <- tibble(
  nom = c("Dupont", "Martin", "Bernard", "Dubois", "Moreau"),
  note_maths = c(15.5, 12.0, 16.8, 10.5, 14.0),
  note_physique = c(14.2, 13.5, 17.5, 11.0, 15.2),
  heures_etude = c(20, 15, 25, 10, 18)
)
```

```{r logo, echo=FALSE, results='asis'}
htmltools::img(src = "images/logo.png", id = "tutorial-logo", alt = "Logo Cnam-Intechmer")
```

## Bienvenue

### Introduction

**Objectifs :**

- ✅ Créer de nouvelles colonnes avec `mutate()`
- ✅ Utiliser `if_else()` et `case_when()` pour des conditions
- ✅ Renommer des colonnes avec `rename()`
- ✅ Utiliser `transmute()` pour ne garder que les nouvelles colonnes

**Durée estimée :** 45 minutes

---

## Section 1 : La fonction mutate()

### Créer une nouvelle colonne

`mutate()` permet de créer ou modifier des colonnes.

```{r demo-mutate, exercise=TRUE}
etudiants |>
  mutate(moyenne = (note_maths + note_physique) / 2)
```

### Exercice 1

Créez une colonne `total` qui est la somme des notes de maths et physique :

```{r ex1-mutate, exercise=TRUE}
etudiants |>
  mutate(_____)
```

```{r ex1-mutate-solution}
etudiants |>
  mutate(total = note_maths + note_physique)
```

---

## Section 2 : Opérations vectorielles

### Opérateurs arithmétiques

```{r demo-operations, exercise=TRUE}
etudiants |>
  mutate(
    moyenne = (note_maths + note_physique) / 2,
    ecart = note_maths - note_physique,
    note_coef_2 = note_maths * 2
  )
```

### Exercice 2

Calculez le nombre d'heures d'étude par point obtenu en maths :

```{r ex2-operations, exercise=TRUE}
etudiants |>
  mutate(_____)
```

```{r ex2-operations-solution}
etudiants |>
  mutate(heures_par_point = heures_etude / note_maths)
```

---

## Section 3 : Conditions avec if_else()

### Syntaxe de if_else()

```r
if_else(condition, valeur_si_vrai, valeur_si_faux)
```

```{r demo-ifelse, exercise=TRUE}
etudiants |>
  mutate(
    moyenne = (note_maths + note_physique) / 2,
    resultat = if_else(moyenne >= 12, "Admis", "Recalé")
  )
```

### Exercice 3

Créez une colonne `travailleur` qui vaut "Oui" si heures_etude > 15, sinon "Non" :

```{r ex3-ifelse, exercise=TRUE}
etudiants |>
  mutate(_____)
```

```{r ex3-ifelse-solution}
etudiants |>
  mutate(travailleur = if_else(heures_etude > 15, "Oui", "Non"))
```

---

## Section 4 : Conditions multiples avec case_when()

### Syntaxe de case_when()

```{r demo-casewhen, exercise=TRUE}
etudiants |>
  mutate(
    moyenne = (note_maths + note_physique) / 2,
    mention = case_when(
      moyenne >= 16 ~ "Très bien",
      moyenne >= 14 ~ "Bien",
      moyenne >= 12 ~ "Assez bien",
      moyenne >= 10 ~ "Passable",
      TRUE ~ "Insuffisant"
    )
  )
```

### Exercice 4

Créez une colonne `niveau` selon la note de maths :
- >= 15 : "Excellent"
- >= 12 : "Bon"
- >= 10 : "Moyen"
- < 10 : "Faible"

```{r ex4-casewhen, exercise=TRUE}
etudiants |>
  mutate(_____)
```

```{r ex4-casewhen-solution}
etudiants |>
  mutate(
    niveau = case_when(
      note_maths >= 15 ~ "Excellent",
      note_maths >= 12 ~ "Bon",
      note_maths >= 10 ~ "Moyen",
      TRUE ~ "Faible"
    )
  )
```

---

## Section 5 : Renommer des colonnes

### La fonction rename()

```{r demo-rename, exercise=TRUE}
etudiants |>
  rename(
    mathematiques = note_maths,
    physique = note_physique
  )
```

### Exercice 5

Renommez `heures_etude` en `temps_travail` :

```{r ex5-rename, exercise=TRUE}
etudiants |>
  rename(_____)
```

```{r ex5-rename-solution}
etudiants |>
  rename(temps_travail = heures_etude)
```

---

## Section 6 : transmute()

### Créer et ne garder que les nouvelles colonnes

```{r demo-transmute, exercise=TRUE}
etudiants |>
  transmute(
    nom,
    moyenne = (note_maths + note_physique) / 2
  )
```

---

## Défi final

Créez un pipeline complet qui :
1. Calcule la moyenne
2. Détermine la mention avec case_when()
3. Garde seulement nom, moyenne et mention
4. Trie par moyenne décroissante

```{r defi-final, exercise=TRUE, exercise.lines=15}
etudiants |>
  # Votre code ici



```

```{r defi-final-solution}
etudiants |>
  mutate(
    moyenne = (note_maths + note_physique) / 2,
    mention = case_when(
      moyenne >= 16 ~ "Très bien",
      moyenne >= 14 ~ "Bien",
      moyenne >= 12 ~ "Assez bien",
      TRUE ~ "Passable"
    )
  ) |>
  select(nom, moyenne, mention) |>
  arrange(desc(moyenne))
```

---

## Récapitulatif

### Aide-mémoire

```{r cheatsheet, echo=TRUE, eval=FALSE}
# CRÉER/MODIFIER DES COLONNES
mutate(nouvelle_col = calcul)
mutate(col = col * 2)  # Modifier existante

# CONDITIONS
mutate(x = if_else(condition, vrai, faux))
mutate(x = case_when(
  cond1 ~ valeur1,
  cond2 ~ valeur2,
  TRUE ~ valeur_defaut
))

# RENOMMER
rename(nouveau_nom = ancien_nom)

# CRÉER ET GARDER SEULEMENT NOUVELLES
transmute(col1, nouvelle = calcul)
```

---

<div class="footer">
  <p>@ Cnam-Intechmer - 2025</p>
</div>
